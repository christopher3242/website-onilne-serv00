<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=windows-1252" />
  <title>Box2dWeb example with Mouse Grab and Wall</title>
</head>
<body onload="init();">
  <h1>Box2d with Mouse Grab and Wall</h1>
  <canvas id="canvas" width="600" height="400"></canvas>
  <script type="text/javascript" src="Box2D.js"></script>
  <script type="text/javascript">
    var world;
    var mouseX = 0, mouseY = 0;
    var mouseJoint = null;
    var selectedBody = null;

    function init() {
      var b2Vec2 = Box2D.Common.Math.b2Vec2,
          b2BodyDef = Box2D.Dynamics.b2BodyDef,
          b2Body = Box2D.Dynamics.b2Body,
          b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
          b2World = Box2D.Dynamics.b2World,
          b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
          b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
          b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
          b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef;

      // Create world with gravity
      world = new b2World(new b2Vec2(0, 10), true);

      // Fixture definition
      var fixDef = new b2FixtureDef;
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;

      // Body definition
      var bodyDef = new b2BodyDef;

      // Create ground
      bodyDef.type = b2Body.b2_staticBody;
      bodyDef.position.x = 9;
      bodyDef.position.y = 13;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(10, 0.5);
      world.CreateBody(bodyDef).CreateFixture(fixDef);

      // Create some random objects
      bodyDef.type = b2Body.b2_dynamicBody;
      for (var i = 0; i < 10; ++i) {
        if (Math.random() > 0.5) {
          fixDef.shape = new b2PolygonShape;
          fixDef.shape.SetAsBox(
            Math.random() + 0.1,
            Math.random() + 0.1
          );
        } else {
          fixDef.shape = new b2CircleShape(
            Math.random() + 0.1
          );
        }
        bodyDef.position.x = Math.random() * 10;
        bodyDef.position.y = Math.random() * 10;
        world.CreateBody(bodyDef).CreateFixture(fixDef);
      }

      // Create a square wall (static)
      var wallDef = new b2BodyDef();
      wallDef.type = b2Body.b2_staticBody;
      wallDef.position.x = 5; // position of the wall
      wallDef.position.y = 5;
      var wallFixture = new b2FixtureDef();
      wallFixture.shape = new b2PolygonShape();
      wallFixture.shape.SetAsBox(1.5, 1.5); // size: 3x3 units
      var wallBody = world.CreateBody(wallDef);
      wallBody.CreateFixture(wallFixture);

      // Setup debug draw
      var debugDraw = new b2DebugDraw();
      debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
      debugDraw.SetDrawScale(30.0);
      debugDraw.SetFillAlpha(0.3);
      debugDraw.SetLineThickness(1.0);
      debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
      world.SetDebugDraw(debugDraw);

      // Mouse event listeners
      var canvas = document.getElementById("canvas");
      canvas.addEventListener("mousedown", handleMouseDown, false);
      canvas.addEventListener("mousemove", handleMouseMove, false);
      canvas.addEventListener("mouseup", handleMouseUp, false);

      // Store mouse position globally
      document.addEventListener("mousemove", function(e) {
        var rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) / 30; // scale for debug draw
        mouseY = (e.clientY - rect.top) / 30;
      });

      // Start update loop
      window.setInterval(update, 1000 / 60);
    }

    function handleMouseDown(e) {
      var b2Vec2 = Box2D.Common.Math.b2Vec2;
      var canvas = document.getElementById("canvas");
      var rect = canvas.getBoundingClientRect();
      var mouseX = (e.clientX - rect.left) / 30;
      var mouseY = (e.clientY - rect.top) / 30;

      var body = getBodyAtMouse(mouseX, mouseY);
      if (body) {
        createMouseJoint(body, mouseX, mouseY);
      }
    }

    function handleMouseMove(e) {
      var rect = document.getElementById("canvas").getBoundingClientRect();
      mouseX = (e.clientX - rect.left) / 30;
      mouseY = (e.clientY - rect.top) / 30;

      if (mouseJoint) {
        mouseJoint.SetTarget(new Box2D.Common.Math.b2Vec2(mouseX, mouseY));
      }
    }

    function handleMouseUp(e) {
      if (mouseJoint) {
        world.DestroyJoint(mouseJoint);
        mouseJoint = null;
      }
    }

    function getBodyAtMouse(x, y) {
      var aabb = new Box2D.Collision.b2AABB();
      aabb.lowerBound.Set(x - 0.001, y - 0.001);
      aabb.upperBound.Set(x + 0.001, y + 0.001);

      var selectedBody = null;

      function getBodyFixtures(fixture) {
        if (fixture.GetBody().GetType() != Box2D.Dynamics.b2Body.b2_staticBody) {
          if (fixture.GetShape().TestPoint(fixture.GetBody().GetTransform(), new Box2D.Common.Math.b2Vec2(x, y))) {
            selectedBody = fixture.GetBody();
            return false; // stop iteration
          }
        }
        return true;
      }

      world.QueryAABB(getBodyFixtures, aabb);
      return selectedBody;
    }

    function createMouseJoint(body, x, y) {
      var b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef;
      var jointDef = new b2MouseJointDef();
      jointDef.bodyA = world.GetGroundBody();
      jointDef.bodyB = body;
      jointDef.target.Set(x, y);
      jointDef.collideConnected = true;
      jointDef.maxForce = 1000.0 * body.GetMass();
      mouseJoint = world.CreateJoint(jointDef);
      body.SetAwake(true);
    }

    function update() {
      world.Step(1 / 60, 10, 10);
      world.DrawDebugData();
      world.ClearForces();
    }
  </script>
  <a href="../games.html"><button id="exitButton">Exit</button></a>
  <button id="restartButton">Restart</button>
  <script>
    document.getElementById("restartButton").addEventListener("click", function() {
      location.reload();
    });
  </script>
</body>
</html>